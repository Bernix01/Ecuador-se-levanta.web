{"version":3,"sources":["../../../../server/api/user/user.controller.js"],"names":[],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\r\n\r\nimport User from './user.model';\r\nimport passport from 'passport';\r\nimport config from '../../config/environment';\r\nimport jwt from 'jsonwebtoken';\r\n\r\nfunction validationError(res, statusCode) {\r\n  statusCode = statusCode || 422;\r\n  return function(err) {\r\n    res.status(statusCode).json(err);\r\n  }\r\n}\r\n\r\nfunction handleError(res, statusCode) {\r\n  statusCode = statusCode || 500;\r\n  return function(err) {\r\n    res.status(statusCode).send(err);\r\n  };\r\n}\r\n\r\n/**\r\n * Get list of users\r\n * restriction: 'admin'\r\n */\r\nexport function index(req, res) {\r\n  return User.find({}, '-salt -password').exec()\r\n    .then(users => {\r\n      res.status(200).json(users);\r\n    })\r\n    .catch(handleError(res));\r\n}\r\n\r\n/**\r\n * Creates a new user\r\n */\r\nexport function create(req, res, next) {\r\n  var newUser = new User(req.body);\r\n  newUser.provider = 'local';\r\n  newUser.role = 'user';\r\n  newUser.save()\r\n    .then(function(user) {\r\n      var token = jwt.sign({ _id: user._id }, config.secrets.session, {\r\n        expiresIn: 60 * 60 * 5\r\n      });\r\n      res.json({ token });\r\n    })\r\n    .catch(validationError(res));\r\n}\r\n\r\n/**\r\n * Get a single user\r\n */\r\nexport function show(req, res, next) {\r\n  var userId = req.params.id;\r\n\r\n  return User.findById(userId).exec()\r\n    .then(user => {\r\n      if (!user) {\r\n        return res.status(404).end();\r\n      }\r\n      res.json(user.profile);\r\n    })\r\n    .catch(err => next(err));\r\n}\r\n\r\n/**\r\n * Deletes a user\r\n * restriction: 'admin'\r\n */\r\nexport function destroy(req, res) {\r\n  return User.findByIdAndRemove(req.params.id).exec()\r\n    .then(function() {\r\n      return res.status(204).end();\r\n    })\r\n    .catch(handleError(res));\r\n}\r\n\r\n/**\r\n * Change a users password\r\n */\r\nexport function changePassword(req, res, next) {\r\n  var userId = req.user._id;\r\n  var oldPass = String(req.body.oldPassword);\r\n  var newPass = String(req.body.newPassword);\r\n\r\n  return User.findById(userId).exec()\r\n    .then(user => {\r\n      if (user.authenticate(oldPass)) {\r\n        user.password = newPass;\r\n        return user.save()\r\n          .then(() => {\r\n            return res.status(204).end();\r\n          })\r\n          .catch(validationError(res));\r\n      } else {\r\n        return res.status(403).end();\r\n      }\r\n    });\r\n}\r\n\r\n/**\r\n * Get my info\r\n */\r\nexport function me(req, res, next) {\r\n  var userId = req.user._id;\r\n\r\n  return User.findOne({ _id: userId }, '-salt -password').exec()\r\n    .then(user => { // don't ever give out the password or salt\r\n      if (!user) {\r\n        return res.status(401).end();\r\n      }\r\n      return res.json(user);\r\n    })\r\n    .catch(err => next(err));\r\n}\r\n\r\n/**\r\n * Authentication callback\r\n */\r\nexport function authCallback(req, res, next) {\r\n  res.redirect('/');\r\n}\r\n"]}